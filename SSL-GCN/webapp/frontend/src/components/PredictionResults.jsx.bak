import { Download, AlertCircle, CheckCircle, XCircle, BarChart3 } from 'lucide-react';
import { useState } from 'react';

const PredictionResults = ({ results }) => {
  const [showComparison, setShowComparison] = useState(false);
  
  if (!results || !results.predictions) {
    return null;
  }

  const { predictions, baseline_predictions, compare_baseline, properties, smiles, canonical_smiles } = results;

  // Calculate overall risk from GCN predictions
  const toxicCount = predictions.filter((p) => p.prediction === 'Toxic').length;
  const totalCount = predictions.length;
  const toxicPercentage = ((toxicCount / totalCount) * 100).toFixed(1);

  const handleDownloadJSON = () => {
    const data = {
      smiles,
      canonical_smiles,
      properties,
      gcn_predictions: predictions,
      baseline_predictions: baseline_predictions || null,
      timestamp: new Date().toISOString(),
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `toxicity_prediction_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleDownloadCSV = () => {
    let csvContent = 'SMILES,Canonical SMILES,Endpoint,Category,Model,Prediction,Probability,Confidence Level\n';
    
    // Add GCN predictions
    predictions.forEach((pred) => {
      csvContent += `"${smiles}","${canonical_smiles}","${pred.endpoint}","${pred.category}","GCN","${pred.prediction}",${pred.probability},"${pred.confidence_level}"\n`;
    });
    
    // Add baseline predictions if available
    if (baseline_predictions) {
      Object.keys(baseline_predictions).forEach((model) => {
        baseline_predictions[model].forEach((pred) => {
          csvContent += `"${smiles}","${canonical_smiles}","${pred.endpoint}","${pred.category}","${model}","${pred.prediction}",${pred.probability},"${pred.confidence_level}"\n`;
        });
      });
    }

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `toxicity_prediction_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="space-y-6 fade-in">
      {/* Overall Summary */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="card">
          <p className="text-xs text-gray-400 uppercase tracking-wide mb-1">
            Total Endpoints
          </p>
          <p className="text-2xl font-bold text-white">{totalCount}</p>
        </div>
        <div className="card">
          <p className="text-xs text-gray-400 uppercase tracking-wide mb-1">
            Toxic Predictions (GCN)
          </p>
          <p className="text-2xl font-bold text-toxic-red">{toxicCount}</p>
        </div>
        <div className="card">
          <p className="text-xs text-gray-400 uppercase tracking-wide mb-1">
            Risk Level
          </p>
          <p className={`text-2xl font-bold ${
            toxicPercentage > 50 ? 'text-toxic-red' : 
            toxicPercentage > 25 ? 'text-toxic-orange' : 
            'text-safe-green'
          }`}>
            {toxicPercentage}%
          </p>
        </div>
      </div>

      {/* GCN Predictions Table */}
      <div className="card overflow-hidden">
        <div className="p-4 border-b border-dark-border flex justify-between items-center">
          <h3 className="text-lg font-semibold text-white">
            GCN Model Predictions
          </h3>
          <div className="flex space-x-2">
            {compare_baseline && baseline_predictions && (
              <button
                onClick={() => setShowComparison(!showComparison)}
                className="btn-secondary flex items-center space-x-2 text-xs"
              >
                <BarChart3 className="w-4 h-4" />
                <span>{showComparison ? 'Hide' : 'Show'} Comparison</span>
              </button>
            )}
            <button
              onClick={handleDownloadCSV}
              className="btn-secondary flex items-center space-x-2 text-xs"
            >
              <Download className="w-4 h-4" />
              <span>CSV</span>
            </button>
            <button
              onClick={handleDownloadJSON}
              className="btn-secondary flex items-center space-x-2 text-xs"
            >
              <Download className="w-4 h-4" />
              <span>JSON</span>
            </button>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-dark-bg border-b border-dark-border">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  Endpoint
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  Category
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  Prediction
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  Probability
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  Confidence
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-dark-border"
              {predictions.map((pred, index) => (
                <tr key={index} className="hover:bg-dark-bg transition-colors">
                  <td className="px-4 py-3 text-sm font-medium text-gray-300">
                    {pred.endpoint}
                  </td>
                  <td className="px-4 py-3 text-xs text-gray-400">
                    {pred.category}
                  </td>
                  <td className="px-4 py-3">
                    <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${
                      pred.prediction === 'Toxic'
                        ? 'bg-toxic-red/20 text-toxic-red border border-toxic-red/30'
                        : 'bg-safe-green/20 text-safe-green border border-safe-green/30'
                    }`}>
                      {pred.prediction === 'Toxic' ? (
                        <XCircle className="w-3 h-3 mr-1" />
                      ) : (
                        <CheckCircle className="w-3 h-3 mr-1" />
                      )}
                      {pred.prediction}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-300">
                    <div className="flex items-center space-x-2">
                      <div className="flex-1 bg-dark-bg rounded-full h-2 w-24">
                        <div
                          className={`h-2 rounded-full ${
                            pred.confidence > 0.7 ? 'bg-safe-green' : 
                            pred.confidence > 0.5 ? 'bg-toxic-orange' : 
                            'bg-toxic-red'
                          }`}
                          style={{ width: `${pred.confidence * 100}%` }}
                        ></div>
                      </div>
                      <span className="text-xs font-mono">
                        {(pred.confidence * 100).toFixed(1)}%
                      </span>
                    </div>
                  </td>
                  <td className="px-4 py-3 text-xs text-gray-400 font-mono">
                    {pred.model}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Molecular Properties */}
      {properties && (
        <div className="card">
          <h3 className="text-lg font-semibold text-white mb-4">
            Molecular Properties
          </h3>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <div>
              <p className="text-xs text-gray-400 mb-1">Molecular Weight</p>
              <p className="text-sm font-medium text-white">{properties.molecular_weight}</p>
            </div>
            <div>
              <p className="text-xs text-gray-400 mb-1">LogP</p>
              <p className="text-sm font-medium text-white">{properties.logp}</p>
            </div>
            <div>
              <p className="text-xs text-gray-400 mb-1">H-Bond Donors</p>
              <p className="text-sm font-medium text-white">{properties.num_h_donors}</p>
            </div>
            <div>
              <p className="text-xs text-gray-400 mb-1">H-Bond Acceptors</p>
              <p className="text-sm font-medium text-white">{properties.num_h_acceptors}</p>
            </div>
            <div>
              <p className="text-xs text-gray-400 mb-1">Rotatable Bonds</p>
              <p className="text-sm font-medium text-white">{properties.num_rotatable_bonds}</p>
            </div>
            <div>
              <p className="text-xs text-gray-400 mb-1">Aromatic Rings</p>
              <p className="text-sm font-medium text-white">{properties.num_aromatic_rings}</p>
            </div>
            <div>
              <p className="text-xs text-gray-400 mb-1">TPSA</p>
              <p className="text-sm font-medium text-white">{properties.tpsa}</p>
            </div>
            <div>
              <p className="text-xs text-gray-400 mb-1">Heavy Atoms</p>
              <p className="text-sm font-medium text-white">{properties.num_heavy_atoms}</p>
            </div>
          </div>
        </div>
      )}

      {/* Disclaimer */}
      <div className="bg-toxic-orange/10 border border-toxic-orange/30 rounded-lg p-4 flex items-start space-x-3">
        <AlertCircle className="w-5 h-5 text-toxic-orange flex-shrink-0 mt-0.5" />
        <div>
          <p className="text-sm font-semibold text-toxic-orange mb-1">
            Important Notice
          </p>
          <p className="text-xs text-gray-400">
            These predictions are computational estimates and should not be used as sole evidence for 
            regulatory decisions. Always validate predictions with experimental data and consult with 
            toxicology experts for critical applications.
          </p>
        </div>
      </div>
    </div>
  );
};

export default PredictionResults;
